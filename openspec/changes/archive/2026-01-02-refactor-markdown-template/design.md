# 技术设计：Markdown 模版系统

## 上下文

### 背景
当前系统中，Markdown 文档的生成逻辑分散在两处：
1. **Server 端** (`filewriter.go:generateMarkdown`) - 用于"保存到 Obsidian"功能
2. **浏览器插件** (`content.js:generateClipboardFrontmatter`) - 用于"复制到剪贴板"功能

这导致：
- 代码重复，维护成本高
- 用户无法自定义输出格式
- 修改格式需要重新编译后端

### 约束
- 浏览器扩展使用 Manifest V3，无法使用 `eval()` 或动态代码执行
- 模版需要存储在 Chrome Storage（有大小限制，单个值最大 8KB）
- 需要保持与现有 AI 摘要功能的兼容

### 利益相关者
- 终端用户：需要自定义 Markdown 格式
- 开发者：需要简化维护成本

## 目标 / 非目标

### 目标
- 统一 Markdown 生成逻辑到浏览器插件
- 提供用户可配置的模版系统
- 简化 Server 端职责（仅负责文件写入）
- 保持现有功能完整性

### 非目标
- 不实现复杂的模版语言（如条件判断、循环）
- 不支持多模版切换（MVP 仅支持单一模版）
- 不实现模版导入/导出功能

## 决策

### 决策 1：模版引擎选择

**选择**：简单字符串占位符替换

**理由**：
- 浏览器扩展安全限制禁止 `eval()`
- 用户场景简单，不需要复杂逻辑
- 实现简单，易于维护

**替代方案**：
- Handlebars.js - 过于复杂，增加包体积
- Mustache.js - 功能超出需求
- 自定义 DSL - 开发成本高

### 决策 2：占位符格式

**选择**：使用 `{{placeholder}}` 格式

**支持的占位符**：
| 占位符 | 说明 | 示例值 |
|--------|------|--------|
| `{{title}}` | 文章标题 | `分布式系统原理` |
| `{{url}}` | 原始 URL | `https://example.com/article` |
| `{{domain}}` | 来源域名 | `example.com` |
| `{{date}}` | 保存日期 (YYYY-MM-DD) | `2025-01-03` |
| `{{datetime}}` | 保存时间 (ISO 8601) | `2025-01-03T10:30:00Z` |
| `{{tags}}` | 标签列表 (YAML 格式) | `- tag1\n- tag2` |
| `{{ai_summary}}` | AI 摘要（如有） | `**摘要：**\n...` |
| `{{highlights}}` | 高亮笔记（如有） | `> **高亮**: ...` |
| `{{content}}` | 正文内容 | Markdown 正文 |

**理由**：
- 双花括号不易与 Markdown 语法冲突
- 直观易懂，用户友好
- 与常见模版引擎语法一致

### 决策 3：默认模版设计

```markdown
---
title: "{{title}}"
url: "{{url}}"
date: {{date}}
tags:
{{tags}}
---

{{ai_summary}}

{{highlights}}

## 正文

{{content}}
```

### 决策 4：API 协议简化

**变更前**：
```json
{
  "content": {
    "markdown": "正文内容",
    "aiSummary": { ... },
    "highlights": [ ... ]
  }
}
```

**变更后**：
```json
{
  "content": {
    "markdown": "完整的 Markdown 文档（含 frontmatter）"
  }
}
```

**理由**：
- Server 不再需要理解内容结构
- 减少 Server 端复杂度
- 浏览器插件已有完整数据，无需再传递结构化数据

## 风险 / 权衡

| 风险 | 缓解措施 |
|------|----------|
| 用户模版语法错误导致输出异常 | 提供模版预览功能；保留恢复默认按钮 |
| 模版过大超出 Storage 限制 | 限制模版最大 5000 字符；提示用户 |
| 向后不兼容导致旧版插件无法使用 | 版本号标识；更新说明文档 |

## 迁移计划

1. **阶段 1**：发布新版 Server（支持简化协议）
2. **阶段 2**：发布新版浏览器插件（使用模版系统）
3. **回滚方案**：如出现严重问题，可回退到旧版本（需同时回退 Server 和插件）

## 待决问题

1. ~~是否需要支持条件渲染（如：无 AI 摘要时隐藏该区块）？~~
   - **决定**：MVP 阶段不支持，占位符为空时输出空字符串
   
2. 是否需要模版版本管理？
   - **待定**：根据用户反馈决定是否在后续版本添加
