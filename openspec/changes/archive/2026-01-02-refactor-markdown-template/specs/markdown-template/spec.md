# 功能规范：Markdown 模版系统

## 新增需求

### 需求：模版占位符系统

系统**必须**支持使用双花括号语法 `{{placeholder}}` 定义占位符，并在渲染时将其替换为实际值。

#### 场景：基本占位符替换
- **当** 模版包含 `{{title}}` 占位符
- **并且** 文章标题为 "分布式系统原理"
- **那么** 渲染结果中 `{{title}}` 被替换为 "分布式系统原理"

#### 场景：未知占位符处理
- **当** 模版包含未定义的占位符 `{{unknown}}`
- **那么** 渲染结果中保留原始文本 `{{unknown}}`

#### 场景：空值占位符处理
- **当** 模版包含 `{{ai_summary}}` 占位符
- **并且** AI 摘要未生成或为空
- **那么** 渲染结果中 `{{ai_summary}}` 被替换为空字符串

---

### 需求：支持的占位符列表

系统**必须**支持以下占位符：

| 占位符 | 数据来源 | 格式 |
|--------|----------|------|
| `{{title}}` | 文章标题 | 纯文本 |
| `{{url}}` | 原始 URL | 纯文本 |
| `{{domain}}` | 来源域名 | 纯文本 |
| `{{date}}` | 保存日期 | YYYY-MM-DD |
| `{{datetime}}` | 保存时间 | ISO 8601 |
| `{{tags}}` | 标签列表 | YAML 列表格式 |
| `{{ai_summary}}` | AI 摘要 | Markdown 格式 |
| `{{highlights}}` | 高亮笔记 | Markdown 格式 |
| `{{content}}` | 正文内容 | Markdown 格式 |

#### 场景：日期格式化
- **当** 保存时间为 `2025-01-03T10:30:00Z`
- **那么** `{{date}}` 渲染为 `2025-01-03`
- **并且** `{{datetime}}` 渲染为 `2025-01-03T10:30:00Z`

#### 场景：标签列表格式化
- **当** 标签为 `["技术", "分布式"]`
- **那么** `{{tags}}` 渲染为：
  ```
    - 技术
    - 分布式
  ```

#### 场景：高亮笔记格式化
- **当** 存在高亮 `{text: "重要内容", note: "我的批注"}`
- **那么** `{{highlights}}` 渲染为：
  ```markdown
  ## 我的笔记

  > **高亮**: 重要内容
  > 
  > 💬 批注: 我的批注

  ---
  ```

---

### 需求：默认模版

系统**必须**提供一个默认模版，用户未自定义时使用此模版。

#### 场景：首次使用加载默认模版
- **当** 用户首次打开设置页面
- **并且** 未保存过自定义模版
- **那么** 模版编辑器显示默认模版内容

#### 场景：恢复默认模版
- **当** 用户点击"恢复默认"按钮
- **那么** 模版编辑器内容被重置为默认模版
- **并且** 显示操作成功提示

---

### 需求：模版编辑器

系统**必须**在设置页面提供模版编辑器，允许用户自定义 Markdown 模版。

#### 场景：编辑并保存模版
- **当** 用户在模版编辑器中修改内容
- **并且** 点击"保存设置"按钮
- **那么** 模版被保存到 Chrome Storage
- **并且** 显示保存成功提示

#### 场景：模版长度限制
- **当** 用户输入的模版超过 5000 字符
- **那么** 显示字符数超限警告
- **并且** 禁止保存

#### 场景：占位符参考文档
- **当** 用户查看模版编辑器区域
- **那么** 显示可用占位符列表及其说明

---

### 需求：模版渲染统一

系统**必须**使用同一套模版渲染逻辑处理"保存到 Obsidian"和"复制到剪贴板"两个功能。

#### 场景：保存到 Obsidian 使用模版
- **当** 用户点击"保存到 Obsidian"按钮
- **那么** 使用用户配置的模版生成完整 Markdown
- **并且** 将生成的 Markdown 发送给 Server 保存

#### 场景：复制到剪贴板使用模版
- **当** 用户点击"复制到剪贴板"按钮
- **那么** 使用用户配置的模版生成完整 Markdown
- **并且** 将生成的 Markdown 写入系统剪贴板

---

## 修改需求

### 需求：简化 Save API 协议

API 请求体中的 `content` 对象**必须**简化为仅包含 `markdown` 字段，该字段**必须**包含完整的、已渲染的 Markdown 文档。

#### 场景：发送简化的请求体
- **当** 浏览器插件调用 `POST /api/v1/save`
- **那么** 请求体格式为：
  ```json
  {
    "metadata": { "title": "...", "url": "...", "domain": "...", "savedAt": "..." },
    "content": { "markdown": "完整的 Markdown 文档内容" },
    "assets": [ ... ]
  }
  ```

#### 场景：Server 直接写入 Markdown
- **当** Server 收到保存请求
- **那么** 直接将 `content.markdown` 写入文件
- **并且** 不进行任何 Markdown 生成或转换

---

## 移除需求

### 需求：移除 Server 端 Markdown 生成逻辑

**原因**：Markdown 生成逻辑移至浏览器插件，Server 仅负责文件写入。

**迁移**：
- 删除 `server/services/filewriter.go` 中的 `generateMarkdown` 函数
- 删除 `server/models/webclip.go` 中的 `AISummary`、`Evidence`、`Highlight` 类型定义
- 简化 `Content` 结构体，仅保留 `Markdown` 字段
