# 功能规范: 前端UI与AI功能优化

**功能分支**: `004-ui-and-ai-enhancements`
**创建时间**: 2025-12-15
**状态**: 草稿
**输入**: 用户描述: "前端功能优化：1. 前端 UI 优化 - 选择浮窗透明度、笔记编辑浮窗 2. 浏览器插件功能优化 - AI summary 增加 OpenRouter provider、自定义 prompt"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 选择浮窗视觉优化 (优先级: P1)

作为一个在网页上阅读文章的用户，我希望选择文字后出现的标记浮窗有半透明背景，这样我可以在操作时仍然看到部分底层内容，不会完全遮挡阅读视线。

**优先级原因**: 这是最基础的 UI 改进，影响所有用户的日常使用体验，实现简单且效果明显。

**独立测试**: 可以通过选择任意文字，观察浮窗背景是否呈现半透明效果来完全测试。

**验收场景**: 

1. **给定** 用户在网页上，**当** 用户选择一段文字时，**那么** 出现的标记浮窗背景具有半透明效果，可以隐约看到底层内容。

2. **给定** 标记浮窗已显示，**当** 用户查看浮窗时，**那么** 浮窗中的按钮和文字仍然清晰可读，不影响操作。

---

### 用户故事 2 - 笔记编辑浮窗优化 (优先级: P1)

作为一个想要添加笔记的用户，我希望在选择文字后点击"笔记"按钮时，能弹出一个类似点击高亮后的编辑浮窗，而不是使用浏览器原生的 prompt 对话框，这样体验更加一致且美观。

**优先级原因**: 当前使用浏览器原生 prompt 对话框体验较差，统一使用自定义编辑浮窗可以提供一致的用户体验。

**独立测试**: 可以通过选择文字、点击笔记按钮，验证是否弹出自定义编辑浮窗来测试。

**验收场景**: 

1. **给定** 用户已选择一段文字且标记浮窗已显示，**当** 用户点击"笔记"按钮时，**那么** 系统显示一个自定义的笔记编辑浮窗（与点击高亮后的编辑器样式一致）。

2. **给定** 笔记编辑浮窗已打开，**当** 用户输入笔记内容并点击保存时，**那么** 系统创建带笔记的高亮，编辑浮窗关闭。

3. **给定** 笔记编辑浮窗已打开，**当** 用户点击取消或按 Escape 键时，**那么** 编辑浮窗关闭，不创建高亮。

---

### 用户故事 3 - OpenRouter AI Provider 支持 (优先级: P2)

作为一个希望使用不同 AI 模型的用户，我希望在设置中可以选择 OpenRouter 作为 AI provider，并能手动输入想要使用的模型名称，这样我可以灵活使用各种 AI 模型来生成摘要。

**优先级原因**: OpenRouter 提供了访问多种 AI 模型的统一接口，增加此选项可以大大扩展用户的模型选择范围。

**独立测试**: 可以通过在设置中选择 OpenRouter、输入模型名称、保存设置，然后使用 AI 摘要功能验证是否正常工作。

**验收场景**: 

1. **给定** 用户打开扩展设置页面，**当** 用户在 AI Provider 下拉菜单中查看选项时，**那么** 可以看到 OpenRouter 作为可选项。

2. **给定** 用户已选择 OpenRouter 作为 AI provider，**当** 用户查看设置界面时，**那么** 系统显示一个文本输入框让用户输入模型名称（如 "openai/gpt-4o"）。

3. **给定** 用户已配置 OpenRouter 和模型名称，**当** 用户使用 AI 摘要功能时，**那么** 系统使用配置的模型通过 OpenRouter API 生成摘要。

---

### 用户故事 4 - 自定义 AI Summary Prompt (优先级: P2)

作为一个希望定制 AI 摘要风格的用户，我希望能在设置页面查看和修改 AI 摘要的 prompt，这样我可以根据自己的需求调整摘要的格式和内容风格。

**优先级原因**: 不同用户对摘要有不同的需求（简洁/详细、格式/语言等），提供自定义 prompt 能力可以满足多样化需求。

**独立测试**: 可以通过在设置中修改 prompt、保存设置、生成摘要，验证摘要是否符合自定义 prompt 的要求。

**验收场景**: 

1. **给定** 用户打开扩展设置页面，**当** 用户查看 AI 设置区域时，**那么** 可以看到当前生效的 AI summary prompt（首次使用时显示默认 prompt）。

2. **给定** 用户在设置页面查看 prompt，**当** 用户修改 prompt 内容并保存时，**那么** 系统保存用户的自定义 prompt。

3. **给定** 用户已保存自定义 prompt，**当** 用户使用 AI 摘要功能时，**那么** 系统使用用户的自定义 prompt 生成摘要。

4. **给定** 用户已保存自定义 prompt，**当** 用户想要恢复默认 prompt 时，**那么** 可以点击"恢复默认"按钮将 prompt 重置为系统默认值。

---

### 边界情况

- 当用户输入的 OpenRouter 模型名称格式不正确时会发生什么？系统应显示友好的错误提示，说明正确的格式（如 "provider/model-name"）。
- 当用户清空自定义 prompt 时会发生什么？系统应自动使用默认 prompt，不允许保存空 prompt。
- 当 OpenRouter API 调用失败时会发生什么？系统应显示清晰的错误信息，帮助用户排查问题（如 API key 无效、模型不存在等）。
- 当用户的自定义 prompt 非常长时会发生什么？系统应设置合理的字符限制（如 2000 字符），超出时给出提示。

## 需求 *(必填)*

### 功能需求

**前端 UI 优化**
- **FR-001**: 选择文字后出现的标记浮窗必须具有半透明背景效果
- **FR-002**: 半透明背景必须确保浮窗内的按钮和文字清晰可读
- **FR-003**: 点击标记浮窗中的"笔记"按钮必须弹出自定义编辑浮窗
- **FR-004**: 笔记编辑浮窗必须与点击高亮后的编辑器保持相同的样式
- **FR-005**: 笔记编辑浮窗必须支持保存、取消操作和快捷键（Enter 保存、Escape 取消）

**AI Provider 优化**
- **FR-006**: 设置页面必须在 AI Provider 下拉菜单中提供 OpenRouter 选项
- **FR-007**: 选择 OpenRouter 后必须显示模型名称输入框
- **FR-008**: 系统必须支持通过 OpenRouter API 调用用户指定的模型
- **FR-009**: 系统必须验证 OpenRouter 模型名称格式的基本合法性

**自定义 Prompt**
- **FR-010**: 设置页面必须显示当前生效的 AI summary prompt
- **FR-011**: 用户必须能够在设置页面编辑和保存自定义 prompt
- **FR-012**: 系统必须提供"恢复默认"按钮来重置 prompt
- **FR-013**: 自定义 prompt 必须持久化存储，刷新页面后不丢失
- **FR-014**: 当用户未设置自定义 prompt 时，系统必须使用代码中定义的默认 prompt

### 关键实体

- **AI Provider 配置**: 用户选择的 AI 服务商类型和相关配置（如模型名称）
- **AI Prompt 配置**: 用户自定义或默认的 AI 摘要 prompt 文本
- **用户设置**: 存储用户的所有配置信息，包括 AI provider、模型、prompt 等

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 100% 的用户在选择文字后看到的标记浮窗具有半透明背景效果
- **SC-002**: 用户使用笔记功能时，从点击笔记按钮到编辑浮窗出现的时间不超过 100ms
- **SC-003**: 90% 的用户首次使用时能成功配置 OpenRouter 并生成摘要
- **SC-004**: 用户可以在 30 秒内完成 AI provider 的切换和配置
- **SC-005**: 用户自定义的 prompt 在保存后，下次打开设置页面时能正确显示

## 假设

- 用户已有 OpenRouter 账号和 API key
- OpenRouter API 遵循标准的 OpenAI 兼容格式
- 默认 prompt 已在现有代码中定义
- 用户设置使用 Chrome Storage API 进行持久化存储
- 笔记编辑浮窗复用现有的编辑器组件样式
