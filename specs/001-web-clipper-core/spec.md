# 功能规范: Web Clipper & Assistant

**功能分支**: `001-web-clipper-core`
**创建时间**: 2025-12-14
**状态**: 草稿
**输入**: 用户描述: 一个允许用户在浏览网页时，零摩擦地将网页正文、高亮笔记、以及 AI 生成的深度总结，一键保存到本地 Obsidian 知识库中的工具组合。

## 用户场景与测试 *(必填)*

### 用户故事 1 - 基础网页剪藏 (优先级: P1)

作为知识工作者，我希望能够在浏览任意网页时，一键将文章正文提取并保存为 Markdown 格式到我的 Obsidian 库中，这样我可以离线阅读和管理我的知识收藏。

**优先级原因**: 这是产品的核心价值主张，没有这个功能，其他所有功能都无法使用。用户最基本的需求就是"保存网页到本地笔记"。

**独立测试**: 可以通过在任意新闻网站点击保存按钮，验证 Markdown 文件是否正确生成在 Obsidian 目录中，且格式正确可读。

**验收场景**: 

1. **给定** 用户正在浏览一篇包含标题、段落、列表的文章, **当** 用户点击保存按钮, **那么** 系统应在 Obsidian 目录中创建一个 Markdown 文件，包含正确的 YAML frontmatter（title, url, date）和格式化的正文内容
2. **给定** 用户正在浏览一个充满广告和侧边栏的页面, **当** 用户点击保存按钮, **那么** 生成的 Markdown 仅包含文章核心内容，效果对标 Safari 阅读模式
3. **给定** 用户在同一天保存多篇文章, **当** 每次保存时, **那么** 每篇文章应有独立的 Markdown 文件，文件名不冲突

---

### 用户故事 2 - 图片本地化 (优先级: P1)

作为知识工作者，我希望网页中的图片能够自动下载到本地，并在 Markdown 中使用相对路径引用，这样即使原网站图片失效或我离线时，我仍然能看到完整的内容。

**优先级原因**: 这是用户明确提出的"关键痛点"。网页图片经常因防盗链、服务器下线等原因失效，图片本地化是知识持久化的核心保障。

**独立测试**: 可以通过保存一篇包含多张图片的文章，然后断开网络连接，在 Obsidian 中打开该笔记，验证所有图片是否正常显示。

**验收场景**: 

1. **给定** 用户保存一篇包含 3 张图片的文章, **当** 保存完成后, **那么** 3 张图片应保存在 `./assets/` 子目录中，Markdown 中的图片链接指向相对路径
2. **给定** 文章中有一张超过 5MB 的大图片, **当** 用户保存时, **那么** 该图片保留原始远程 URL，其他小于 5MB 的图片正常本地化
3. **给定** 图片来自有防盗链保护的网站, **当** 用户在浏览器中保存时, **那么** 系统应成功下载图片（利用当前会话的 Cookie 和 Referer）

---

### 用户故事 3 - 高亮与笔记 (优先级: P2)

作为知识工作者，我希望在阅读网页时能够选中重要文字进行高亮，并添加我的个人批注，这些内容在保存时会被一并导出到 Markdown 中。

**优先级原因**: 这是从"被动收藏"到"主动学习"的关键升级。允许用户在阅读时即时记录想法，增强知识吸收效果。

**独立测试**: 可以通过在网页上选中多段文字添加高亮和批注，然后保存，验证 Markdown 中是否包含用户笔记区且格式正确。

**验收场景**: 

1. **给定** 用户选中一段文字, **当** 用户点击"高亮"按钮, **那么** 该文字在页面上显示高亮样式
2. **给定** 用户选中一段文字, **当** 用户点击"高亮+批注"并输入批注内容, **那么** 该文字高亮显示，且批注与高亮关联
3. **给定** 用户在页面上创建了多个高亮和批注, **当** 用户保存网页时, **那么** 导出的 Markdown 中包含独立的"用户笔记区"，汇总所有高亮文本和对应批注
4. **给定** 用户刷新页面, **当** 页面重新加载后, **那么** 之前的高亮和批注不保留（一次性会话设计）

---

### 用户故事 4 - AI 深度总结 (优先级: P3)

作为知识工作者，我希望系统能基于文章正文自动生成 AI 总结，包括核心观点列表和逻辑关系图，帮助我快速把握文章要点。

**优先级原因**: 这是差异化价值功能，将工具从"收藏器"升级为"智能助手"。但它依赖基础的内容提取功能，且需要 AI 服务支持。

**独立测试**: 可以通过保存一篇长文，验证 Markdown 中是否包含 AI 摘要区，且包含核心论点列表和 Mermaid 图表。

**验收场景**: 

1. **给定** 用户保存一篇文章且 AI 功能已启用, **当** 保存完成后, **那么** Markdown 中应包含"AI 摘要区"，包含核心论点列表
2. **给定** AI 生成的总结, **当** 显示在 Markdown 中时, **那么** 应包含支撑论据的引用（来自原文）
3. **给定** AI 生成的总结, **当** 显示在 Markdown 中时, **那么** 应包含一个 Mermaid 格式的逻辑关系图
4. **给定** AI 服务暂时不可用, **当** 用户保存时, **那么** 系统应正常保存正文和图片，AI 摘要区显示占位标记"[AI 总结待生成]"

---

### 边界情况

- 当网页没有可识别的正文内容（如纯图片页面、视频页面）时会发生什么？
  → 系统应提示用户"未能识别有效正文内容"，但仍允许保存页面基本信息（标题、URL）

- 当本地 Go 服务未运行时会发生什么？
  → 插件应显示明确的错误提示"无法连接到本地服务"，并提供启动服务的指引

- 当 Obsidian 目标目录不存在或无写入权限时会发生什么？
  → Go 服务应尝试创建目录，如果权限不足则返回具体错误"权限不足，无法写入 [路径]"

- 当网络中断导致部分图片下载失败时会发生什么？
  → 已下载的图片正常保存，失败的图片保留原始 URL，并在 Markdown 中添加注释标记

- 当用户短时间内重复保存同一网页时会发生什么？
  → 系统应通过内容 Hash 或 URL 识别重复，生成新版本文件而非覆盖（如 `文章标题_v2.md`）

## 需求 *(必填)*

### 功能需求

**内容提取模块**

- **FR-001**: 系统必须能够从任意网页中提取核心正文内容，去除广告、侧边栏、弹窗等干扰元素
- **FR-002**: 系统必须将提取的 HTML 正文转换为标准 Markdown 格式，保留标题层级、列表、代码块、引用等格式
- **FR-003**: 系统必须遍历正文中的所有图片，在浏览器端下载并转换为 Base64 格式
- **FR-004**: 系统必须为每张下载的图片生成唯一的 Hash 文件名，防止命名冲突
- **FR-005**: 系统必须将 Markdown 中的图片链接替换为相对路径格式（`./assets/[hash].png`）
- **FR-006**: 系统必须跳过单张大小超过 5MB 的图片，保留其原始远程 URL

**智能交互模块**

- **FR-007**: 用户必须能够选中网页文本后看到悬浮菜单，提供"高亮"和"高亮+批注"选项
- **FR-008**: 系统必须在页面上以视觉样式（如背景色）显示用户的高亮文本
- **FR-009**: 系统必须在保存时收集页面上所有的高亮和批注数据

**AI 增强模块**

- **FR-010**: 系统必须能够将提取的正文纯文本发送给 AI 服务请求生成总结
- **FR-011**: AI 总结必须包含：核心论点列表、支撑论据引用、Mermaid 格式逻辑图
- **FR-012**: 当 AI 服务不可用时，系统必须能够正常完成其他保存操作，AI 摘要区显示占位标记"[AI 总结待生成]"
- **FR-012a**: AI 服务必须同时生成文章的 tags 标签（3-5 个相关标签），用于 YAML frontmatter

**数据持久化模块**

- **FR-013**: 系统必须将所有数据（Markdown、图片）打包为单个请求发送给本地服务
- **FR-014**: 本地服务必须对文件名进行安全清洗，防止路径穿越攻击
- **FR-015**: 本地服务必须实现原子性写入：只有当所有文件都成功写入后才返回成功
- **FR-016**: 本地服务必须按日期归档，每篇文章有独立子目录，结构为 `{Vault}/Inbox/WebClips/{YYYY-MM-DD}/{文章标题}/`
- **FR-017**: 每篇文章的独立子目录必须包含 `assets/` 子目录存放图片，以及 `index.md` 或以文章标题命名的 Markdown 文件
- **FR-018**: 本地服务 API 调用必须携带 Auth Token 进行简单鉴权

**Markdown 排版**

- **FR-019**: 生成的 Markdown 必须包含 YAML Frontmatter，包含 title、url、date、tags 字段（tags 由 AI 自动生成 3-5 个相关标签）
- **FR-020**: Markdown 内容排版顺序必须为：AI 摘要区 → 用户笔记区 → 正文区
- **FR-021**: 正文区的图片必须使用相对路径 `./assets/[filename]` 引用

### 关键实体

- **WebClip**: 代表一次网页剪藏操作，包含元数据（标题、URL、来源域名、保存日期）、Markdown 正文、AI 总结、用户笔记
- **Asset**: 代表一个本地化的资源文件（主要是图片），包含文件名（Hash 生成）、原始 URL、Base64 数据、文件类型
- **Highlight**: 代表用户的一次高亮操作，包含高亮文本内容、在页面中的位置、可选的批注内容
- **AISummary**: 代表 AI 生成的总结，包含核心论点列表、支撑引用、Mermaid 图表代码

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户可以在 10 秒内完成一篇普通文章的保存操作（从点击按钮到收到成功提示）
- **SC-002**: 95% 以上的网页图片能够成功本地化（排除 >5MB 的大图和跨域受限资源）
- **SC-003**: 生成的 Markdown 在 Obsidian 中打开后，格式正确率达到 90% 以上（标题层级、列表、代码块等）
- **SC-004**: 正文提取质量对标 Safari 阅读模式，核心内容保留完整，无广告/导航残留
- **SC-005**: 用户高亮和批注 100% 出现在导出的 Markdown 用户笔记区中
- **SC-006**: 系统支持单次保存包含 20 张以内图片的文章，不会导致浏览器崩溃或超时
- **SC-007**: 离线状态下，用户能够在 Obsidian 中正常查看已保存文章的所有本地化图片

## 假设

以下假设在没有用户明确澄清的情况下采用：

1. **LLM 服务配置**: 假设 AI 总结功能使用用户自行配置的 LLM API（如 OpenAI、Claude 等），配置方式将在后续设计中定义
2. **Obsidian 库路径**: 假设用户会在插件设置中配置 Obsidian 库的根目录路径
3. **浏览器支持**: 假设主要支持 Chromium 内核浏览器（Chrome、Edge），使用 Manifest V3
4. **本地服务端口**: 假设 Go 服务默认运行在 `localhost:18080`（可配置）
5. **Auth Token**: 假设使用简单的静态 Token 方式鉴权，Token 在插件和服务端配置中保持一致
