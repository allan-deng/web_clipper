# 功能规范: 高亮交互优化

**功能分支**: `003-highlight-interaction`
**创建时间**: 2025-12-15
**状态**: 草稿
**输入**: 用户描述: "优化前端体验：1. 鼠标移动到已经高亮的区域时，如果有笔记，需要展示一个浮窗显示笔记内容。并且可以删除、修改笔记 2. 鼠标点击高亮的区域，应该可以快速打开笔记编辑器，直接编辑笔记内容。也可以选择删除高亮"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 悬停查看笔记浮窗 (优先级: P1)

作为一个在网页上做了高亮和笔记的用户，我希望当鼠标悬停在高亮区域时能看到之前添加的笔记内容，这样我可以快速回顾自己的批注而不需要额外操作。

**优先级原因**: 这是最基础的交互需求，让用户能够快速查看已有笔记，提供即时反馈。

**独立测试**: 可以通过在页面上创建带笔记的高亮，然后悬停查看浮窗是否正确显示笔记内容来测试。

**验收场景**: 

1. **给定** 用户已在页面上创建了一个带笔记的高亮，**当** 用户将鼠标移动到高亮区域上时，**那么** 系统在高亮附近显示一个浮窗，展示笔记内容。

2. **给定** 浮窗正在显示，**当** 用户将鼠标移出高亮区域时，**那么** 浮窗在短暂延迟后自动消失。

3. **给定** 用户已在页面上创建了一个没有笔记的纯高亮，**当** 用户将鼠标移动到高亮区域上时，**那么** 不显示浮窗（或显示简单的工具栏提示）。

---

### 用户故事 2 - 点击编辑笔记 (优先级: P1)

作为一个想要修改或添加笔记的用户，我希望点击高亮区域时能快速打开一个编辑器，这样我可以方便地编辑笔记内容。

**优先级原因**: 编辑笔记是核心功能，用户需要能够修改已有批注或为纯高亮添加笔记。

**独立测试**: 可以通过点击高亮区域，验证编辑器是否打开，输入内容并保存，然后再次悬停验证笔记是否更新。

**验收场景**: 

1. **给定** 用户已在页面上创建了一个高亮（有或无笔记），**当** 用户点击该高亮区域时，**那么** 系统显示一个笔记编辑器，如有现有笔记则预填充内容。

2. **给定** 笔记编辑器已打开，**当** 用户输入/修改笔记内容并确认保存时，**那么** 笔记内容被更新，编辑器关闭。

3. **给定** 笔记编辑器已打开，**当** 用户点击取消或点击编辑器外部时，**那么** 编辑器关闭，不保存更改。

---

### 用户故事 3 - 删除高亮和笔记 (优先级: P2)

作为一个想要清理不需要的高亮的用户，我希望能够删除已创建的高亮（连同其笔记），这样我可以管理页面上的批注。

**优先级原因**: 删除功能是完整 CRUD 操作的一部分，但优先级略低于查看和编辑。

**独立测试**: 可以通过在笔记编辑器或浮窗中点击删除按钮，验证高亮和笔记是否从页面上移除。

**验收场景**: 

1. **给定** 笔记编辑器已打开，**当** 用户点击"删除高亮"按钮时，**那么** 系统显示确认提示。

2. **给定** 删除确认提示已显示，**当** 用户确认删除时，**那么** 高亮和关联的笔记从页面上移除，高亮文本恢复为普通文本。

3. **给定** 删除确认提示已显示，**当** 用户取消时，**那么** 高亮保持不变，返回编辑器。

---

### 边界情况

- 当高亮区域非常小（如单个字符）时会发生什么？浮窗和编辑器应正常显示在可见位置。
- 当高亮位于页面边缘时会发生什么？浮窗/编辑器应自动调整位置，确保不超出视口。
- 当页面上有多个重叠的高亮时会发生什么？点击应触发最上层（最近创建的）高亮的编辑器。
- 当用户快速移动鼠标经过多个高亮时会发生什么？应有适当的防抖处理，避免浮窗闪烁。
- 当笔记内容非常长时会发生什么？浮窗应有最大高度限制，超出部分可滚动。

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须在用户悬停到带笔记的高亮区域时显示笔记浮窗
- **FR-002**: 浮窗必须显示完整的笔记内容
- **FR-003**: 浮窗必须在鼠标移出后自动隐藏（延迟 300ms 以允许鼠标移入浮窗）
- **FR-004**: 系统必须在用户点击高亮区域时显示笔记编辑器
- **FR-005**: 笔记编辑器必须支持输入和编辑文本内容
- **FR-006**: 笔记编辑器必须提供保存和取消按钮
- **FR-007**: 笔记编辑器必须提供删除高亮的选项
- **FR-008**: 删除高亮前必须显示确认提示
- **FR-009**: 删除高亮后必须将高亮文本恢复为普通文本
- **FR-010**: 浮窗和编辑器的位置必须自动调整以保持在视口内
- **FR-011**: 对于没有笔记的纯高亮，点击时应直接打开编辑器以添加笔记
- **FR-012**: 编辑器应支持快捷键操作（Enter 保存，Escape 取消）

### 关键实体

- **高亮 (Highlight)**: 用户在网页上标记的文本区域，包含文本内容、颜色、位置信息、关联的笔记（可选）
- **笔记 (Note)**: 用户对高亮添加的批注文本，关联到特定高亮
- **浮窗 (Tooltip)**: 悬停时显示的临时 UI 元素，展示笔记预览
- **编辑器 (Editor)**: 点击时显示的模态/内联编辑器，用于编辑笔记内容

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户悬停到高亮后 200ms 内显示浮窗
- **SC-002**: 用户点击高亮后 100ms 内显示编辑器
- **SC-003**: 90% 的用户能在首次使用时成功查看和编辑笔记
- **SC-004**: 浮窗和编辑器在所有位置（包括页面边缘）都能正确显示
- **SC-005**: 删除操作需要用户确认，防止误删

## 假设

- 用户使用支持鼠标悬停事件的设备（桌面浏览器）
- 高亮和笔记数据存储在内存中（页面刷新后丢失，与现有行为一致）
- 浮窗使用固定宽度（约 250px），高度自适应内容（最大 200px）
- 编辑器使用内联弹窗样式，与现有扩展 UI 风格一致
- 快捷键仅在编辑器获得焦点时生效
